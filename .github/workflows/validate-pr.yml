name: Validate Plugin Submission

on:
  pull_request:
    paths:
      - 'plugins/**'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: 'plugins/**/manifest.json'

      - name: Validate manifests
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "========================================"
            echo "Validating: $file"
            echo "========================================"

            # È™åËØÅ JSON Ê†ºÂºè
            echo "üìù Checking JSON format..."
            node scripts/validate-manifest.js "$file"

            # ÂÆâÂÖ®Ê£ÄÊü•
            echo "üîí Running security check..."
            node scripts/check-repo-security.js "$file"

            echo "‚úÖ $file passed validation"
            echo ""
          done

      - name: Check version immutability
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          # Ê£ÄÊü•ÊòØÂê¶ÊúâÁâàÊú¨ÂØπÂ∫îÁöÑ ZIP Â∑≤Â≠òÂú®ÔºàÁâàÊú¨‰∏çÂèØÂèòÔºâ
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            PLUGIN_DIR=$(dirname "$file")

            # ËØªÂèñ manifest ‰∏≠ÁöÑÊâÄÊúâÁâàÊú¨ÔºàÊîØÊåÅÊñ∞ÊóßÁªìÊûÑÔºâ
            VERSIONS=$(node -e "
              const fs = require('fs');
              const manifest = JSON.parse(fs.readFileSync('$file'));

              // Êñ∞ÁªìÊûÑÔºö‰ΩøÁî® versions Êï∞ÁªÑ
              if (Array.isArray(manifest.versions)) {
                manifest.versions.forEach(v => console.log(v.version));
              }
              // ÊóßÁªìÊûÑÔºö‰ΩøÁî® version Â≠óÊÆµ
              else if (manifest.version) {
                console.log(manifest.version);
              }
              // ÂÖúÂ∫ïÔºö‰ΩøÁî® latestVersion
              else if (manifest.latestVersion) {
                console.log(manifest.latestVersion);
              }
            ")

            # Ê£ÄÊü•‰∏ªÂàÜÊîØÊòØÂê¶Â∑≤ÊúâËøô‰∫õÁâàÊú¨ÁöÑ ZIP
            git fetch origin main:main 2>/dev/null || true

            for VERSION in $VERSIONS; do
              ZIP_FILE="$PLUGIN_DIR/versions/$VERSION.zip"

              if git show main:"$ZIP_FILE" >/dev/null 2>&1; then
                echo "‚ùå Error: Version $VERSION already exists for $(basename $PLUGIN_DIR)"
                echo "   Versions are immutable. Please increment the version number."
                exit 1
              fi
            done
          done

          echo "‚úÖ All versions are new and valid"

      - name: Check for duplicate plugin IDs
        run: |
          echo "Checking for duplicate plugin IDs..."

          node -e "
          const fs = require('fs');
          const path = require('path');
          const ids = new Map();

          for (const category of ['official', 'community']) {
            const categoryDir = path.join('plugins', category);
            if (!fs.existsSync(categoryDir)) continue;

            const pluginDirs = fs.readdirSync(categoryDir).filter(item => {
              const itemPath = path.join(categoryDir, item);
              return fs.statSync(itemPath).isDirectory();
            });

            for (const pluginId of pluginDirs) {
              const manifestPath = path.join(categoryDir, pluginId, 'manifest.json');
              if (!fs.existsSync(manifestPath)) continue;

              const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf-8'));

              if (ids.has(manifest.id)) {
                console.error(\`‚ùå Duplicate plugin ID found: \${manifest.id}\`);
                console.error(\`   First seen in: \${ids.get(manifest.id)}\`);
                console.error(\`   Duplicate in: \${category}/\${pluginId}\`);
                process.exit(1);
              }

              ids.set(manifest.id, \`\${category}/\${pluginId}\`);
            }
          }

          console.log('‚úÖ No duplicate IDs found');
          "

      - name: Test registry generation
        run: npm run generate-registry

      - name: Comment PR with success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              '‚úÖ **Automated validation passed!**',
              '',
              'Your plugin submission has passed all automated checks:',
              '- ‚úÖ JSON format is valid',
              '- ‚úÖ All required fields are present',
              '- ‚úÖ Repository is accessible',
              '- ‚úÖ Security scan passed',
              '- ‚úÖ No duplicate plugin IDs',
              '- ‚úÖ Version numbers are unique',
              '',
              '**Next steps:**',
              '1. A maintainer will review your plugin code',
              '2. Address any feedback from maintainers',
              '3. Once approved and merged, GitHub Actions will automatically build and package your plugin',
              '4. Your plugin will appear in the marketplace!',
              '',
              'Thank you for your contribution! üéâ'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })

      - name: Comment PR with failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              '‚ùå **Automated validation failed**',
              '',
              'Please review the error logs above and fix the issues.',
              '',
              '**Common problems:**',
              '- Invalid JSON format in manifest.json',
              '- Missing required fields (id, name, version, repository, etc.)',
              '- Invalid repository URL or repository not accessible',
              '- Trying to overwrite an existing version (versions are immutable)',
              '- Duplicate plugin ID',
              '- Security concerns detected',
              '',
              '**Resources:**',
              '- [Contributing Guide](https://github.com/esengine/ecs-editor-plugins/blob/main/CONTRIBUTING.md)',
              '- [Plugin Template](https://github.com/esengine/ecs-editor-plugins/tree/main/PLUGIN_TEMPLATE)',
              '',
              'Feel free to ask for help in the comments if you need assistance!'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })
